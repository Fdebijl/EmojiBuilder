function ControlsAndMenu(){$(".clear").on("vclick",function(e){$("#drawboard").empty()}),$(".open").on("vclick",function(e){LoadSVG()}),$(".saveas").on("vclick",function(e){ShowModal("save-modal",0)}),$(".delete").on("vclick",function(e){$(".selected").remove()}),$(".forward").on("vclick",function(e){$(".selected").parent().insertAfter($(".selected").parent().next())}),$(".backward").on("vclick",function(e){$(".selected").parent().insertBefore($(".selected").parent().prev())}),$(".fliphorizontal").on("vclick",function(e){$(".selected").parent().insertBefore($(".selected").parent().prev())}),$(".flipvertical").on("vclick",function(e){$(".selected").parent().insertBefore($(".selected").parent().prev())}),$(".help").on("vclick",function(e){ShowModal("info-modal",0)}),$(".download-png").on("vclick",function(e){SaveAsPNG()}),$(".download-svg").on("vclick",function(e){SaveAsSVG()})}function allowDrop(e){e.preventDefault()}function appendEmoji(e){addSVGtoDrawboard(document.getElementById(e.dataTransfer.getData("text/html")))}function appendSource(e){e.dataTransfer.setData("text/html",e.target.id)}function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}function showGrid(e){$(".grid").fadeOut(333,function(){$(".grid_"+e).show(),$(".tab").removeClass("tab_active"),$(".tab_"+e).addClass("tab_active")})}function Draggable(e){let t=e,n=t.ownerSVGElement.createSVGPoint(),a=t.ownerSVGElement.createSVGPoint(),o=t.ownerSVGElement.createSVGPoint();function r(e,n){let a=t.ownerSVGElement.createSVGPoint(),o=t.parentNode.getScreenCTM();return a.x=e,a.y=n,a.matrixTransform(o.inverse())}$(t).on("vmousedown",function(e){e.preventDefault(),a=r(e.clientX,e.clientY),$(t).addClass("dragged"),$(t.ownerSVGElement).on("vmousemove",t,function(e){let i=r(e.clientX,e.clientY);o.x=n.x+(i.x-a.x),o.y=n.y+(i.y-a.y),t.setAttribute("transform","translate("+o.x+","+o.y+")")}),$(t.ownerSVGElement).on("vmouseup",t,function(e){n.x=o.x,n.y=o.y,$(t).removeClass("dragged"),$(t.ownerSVGElement).off("vmousemove"),$(t.ownerSVGElement).off("vmouseup")})})}function getSVGFilesInDirectory(e){$.ajax({url:"svgs.json"}).done(function(t){let n=e,a=t;for(i=0;i<a.length;i++)for($(".emojigrid").append('<div class="grid grid_'+a[i].name+'"></div>'),$(".tabs").append('<div class="tab tab_'+a[i].name+'" data-cat="'+a[i].name+'">'+capitalizeFirstLetter(a[i].name)+"</div>"),j=0;j<a[i].dir.length;j++){let e='<img draggable="true" class="svg-icon" id="'+a[i].dir[j].file.split(".")[0]+'" src="'+n+a[i].name+"/"+a[i].dir[j].file+'">';$(".grid_"+a[i].name).append($.parseHTML(e))}$(".tabs > div").click(function(e){showGrid($(this).data("cat"))}),$(".svg-icon").click(function(e){addSVGtoDrawboard(this)});let o=document.getElementsByClassName("svg-icon");Array.from(o).forEach(function(e){e.addEventListener("dragstart",function(e){appendSource(e)})}),showGrid("faces")})}function addSVGtoDrawboard(e){$(".wrapper").append($.parseHTML('<div class="stagingarea" style="display: none;"></div>')),$(".hinter").remove(),$(".stagingarea").load(e.src,function(){$("#drawboard").append($(".stagingarea").html()),$("defs").remove(),$("metadata").remove(),$(".stagingarea").remove(),makePathsDraggable()})}function addSVGstring(e){$(".wrapper").append($.parseHTML('<div class="stagingarea" style="display: none;"></div>')),$(".hinter").remove(),$(".stagingarea").html(e),$("#drawboard").append($(".stagingarea").html()),$("defs").remove(),$("metadata").remove(),$(".stagingarea").remove(),makePathsDraggable()}function SaveAsPNG(){UIkit.modal(document.getElementById("loading-modal")).show();$(".wrapper").append($.parseHTML('<canvas id="renderbox"></canvas>')),$("#renderbox, #drawboard > svg").width($("#drawboard").outerWidth()),$("#renderbox, #drawboard > svg").height($("#drawboard").outerHeight());let e="";if(1===$("#drawboard > svg").length)e=$.trim($("#drawboard").html().replace(/<!--[\s\S]*?-->/gi,""));else{let t='<div class="mergehelper" style="display: none;"></div>';$(".wrapper").append($.parseHTML(t)),$(".mergehelper").html($("#drawboard").html()),$(".mergehelper").html($(".mergehelper").html().replace(/<!--[\s\S]*?-->/gi,""));let n=$(".mergehelper > svg");for(i=1;i<n.length;i++){let e=$(n[i]).html();$(".mergehelper > svg").eq(0).append(e),$(n[i]).remove()}e=$.trim($(".mergehelper").html())}$("svg").css("width","auto").css("height","auto"),canvg("renderbox",e,{renderCallback:function(){setTimeout(function(){let e=document.getElementById("renderbox").toDataURL("image/png"),t=document.createElement("a");t.href=e,t.download="emoji.png",t.click(),$(t).remove(),UIkit.modal(document.getElementById("loading-modal")).hide(),$("#renderbox, .mergehelper").remove()},333*$("#drawboard > svg").length)}})}function SaveAsSVG(){let e="data:image/svg+xml;charset=utf-8,"+encodeURIComponent($("#drawboard").html()),t=document.createElement("a");t.href=e,t.download="emoji.svg",t.click(),$(t).remove()}function LoadSVG(){let e=$(document.createElement("input"));return e.attr("type","file"),e.on("change",function(e){let t=this.files[0],n=new FileReader;n.onload=function(e){addSVGstring(e.target.result)},n.readAsText(t)}),e.click(),!1}function ShowModal(e,t=10){t>0?(UIkit.modal(document.getElementById(e)).show(),setTimeout(function(){UIkit.modal(document.getElementById(e)).hide()},1e3*t)):UIkit.modal(document.getElementById(e)).show()}function makePathsDraggable(){$("path").each(function(){new Draggable(this),$(this).on("vclick",function(e){$("path").removeClass("selected"),$(e.target).addClass("selected")})})}$(window).on("securitypolicyviolation",function(e){let t=e.original,n={time:Date.now(),uri:t.blockedURI,docuri:t.documentURI,disposition:t.disposition,effectivedirective:t.effectiveDirective,violateddirective:t.violatedDirective,line:t.lineNumber,referrer:t.referrer,sample:t.sample};$.ajax({url:"https://floris.amsterdam/reports/csp",method:"POST",data:n}).done(function(e){let t=`https://github.com/Fdebijl/EmojiBuilder/issues/new?title=CSP%20Violation&body=${encodeURI(JSON.stringify(n,null,4))}`;$("#csp-issue-link").attr("href",t),ShowModal("fatal-modal",30)})}),$(document).ready(function(){document.getElementById("drawboard").addEventListener("drop",function(e){e.preventDefault(),e.stopPropagation(),appendEmoji(e)}),document.getElementById("drawboard").addEventListener("dragover",function(e){e.preventDefault(),e.stopPropagation(),allowDrop(e)});getSVGFilesInDirectory("svg/"),setTimeout(function(){$(".hinting").removeClass("hinting")},15e3),$(".ui-loader").remove(),ControlsAndMenu(),"serviceWorker"in navigator&&navigator.serviceWorker.register("/test/emojiworker.js"),navigator.storage&&navigator.storage.persist&&($(".persist").removeClass("disabled"),navigator.storage.estimate().then(e=>{$(".cachesize").html(`${Math.round(e.usage/1e3/1e3*100)/100}MB`)}),$(".persist").on("vclick",function(e){ShowModal("persist-modal",0)}),$(".persist-granted").on("vclick",function(e){navigator.storage.persist().then(e=>{console.info("Persistent storage permissisons granted.")})}))}),$("html").keyup(function(e){46==e.keyCode&&$(".selected").remove()});